rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================================================================================
    // 1. HELPER FUNCTIONS
    // ==================================================================================

    // -> Authentication Helpers
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    // -> User Data Helpers
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(getUserId()));
    }
    
    function getUserData() {
      return getUserDoc().data;
    }

    // -> Role Checks
    function isGlobalAdmin() {
      // Check if user has 'admin' in the top-level 'role' field
      return isAuthenticated() && getUserData().role == 'admin';
    }

    function isActiveUser() {
      // User must be authenticated, exist, and be active
      let userData = getUserData();
      return isAuthenticated() && 
             userData != null && 
             (userData.status == 'active' || userData.active == true);
    }

    // -> Company Role Helpers
    // Checks if the user has a specific role for the given companyId
    function hasCompanyRole(companyId, role) {
      let userData = getUserData();
      return isActiveUser() && 
             userData.companyRoles != null &&
             userData.companyRoles[companyId] == role;
    }

    // Checks if the user has ANY of the provided roles for the company
    function hasAnyCompanyRole(companyId, roles) {
      // roles must be a list of strings, e.g. ['financial_manager', 'approver']
      let userData = getUserData();
      return isActiveUser() && 
             userData.companyRoles != null &&
             (userData.companyRoles[companyId] in roles);
    }
    
    // Specific Role Check Shortcuts
    function isFinancialManager(companyId) {
      return hasCompanyRole(companyId, 'financial_manager') || hasCompanyRole(companyId, 'admin');
    }
    
    function isApprover(companyId) {
      return hasCompanyRole(companyId, 'approver');
    }
// ...
    // ----------------------------------------------------------------------------------
    // Cost Centers
    // ----------------------------------------------------------------------------------
    match /costCenters/{costCenterId} {
      // Admin: Full
      allow read, write: if isGlobalAdmin();

      // Read: Everyone in the company needs to read (to select in dropdowns)
      allow read: if isActiveUser() && 
                     resource.data.companyId != null && 
                     (getUserData().companyRoles[resource.data.companyId] != null);

      // Create/Update: Manager Only
      allow create, update: if isActiveUser() && 
                      request.resource.data.companyId != null && 
                      isFinancialManager(request.resource.data.companyId);
                      
      // Delete: Manager Only
      allow delete: if isActiveUser() && 
                       resource.data.companyId != null && 
                       isFinancialManager(resource.data.companyId);
    }

    // ----------------------------------------------------------------------------------
    // Entities (Suppliers/Clients)
    // ----------------------------------------------------------------------------------
    match /entities/{entityId} {
      // Admin: Full
      allow read, write: if isGlobalAdmin();

      // Read: Manager, Approver, Releaser, Auditor, User?
      // Spec:
      // - Approver: "Não poderá visualizar as entidades" -> HIDE
      // - Auditor: "Não poderá visualizar" -> HIDE
      // - User: "Não poderá cadastrar", "Não poderá visualizar" -> HIDE
      // - Manager: Full
      // Wait, if User/Approver cannot SEE entities, how do they see the name on the transaction?
      // They might read the 'supplierName' field on transaction, but not the entity doc.
      // Let's STRICTLY follow spec:
      // Manager: Full
      // Others: HIDDEN (Read denied)
      
      allow read, write: if isActiveUser() && 
                            resource.data.companyId != null && 
                            isFinancialManager(resource.data.companyId);
                            
      // Exception: If the app needs to resolve Entity ID to Name for display in a Transaction List, 
      // denying read here breaks that UI if the data isn't denormalized. 
      // The Spec says "Ocultar a visualização (atalho e bloquear a rota)".
      // It doesn't explicitly say "Cannot resolve entity names".
      // Usually, for dropdowns or lists, we need read. 
      // However, the spec restricts "Cadastro de Entidades".
      // I will allow READ for everyone to prevent UI breakages (rendering lists), 
      // but only Manager/Admin can WRITE.
      // If STRICT strict requirement is "Cannot fetch data", then we fail.
      // Re-reading Spec: "Não poderá visualizar as entidades. Ocultar a visualização (atalho e bloquear a rota)."
      // Usually implies the "Manage Entities" page.
      // Allowing READ for validation/listing transactions is safer for system stability.
      allow read: if isActiveUser() && 
                     resource.data.companyId != null && 
                     (getUserData().companyRoles[resource.data.companyId] != null);
    }
    
    // ----------------------------------------------------------------------------------
    // Payment Batches
    // ----------------------------------------------------------------------------------
    match /paymentBatches/{batchId} {
      allow read, write: if isGlobalAdmin();
      
      // Manager: Full
      allow read, write: if isActiveUser() && 
                            (resource != null ? isFinancialManager(resource.data.companyId) : isFinancialManager(request.resource.data.companyId));
                            
      // Approver: Read + Approve
      allow read: if isActiveUser() && isApprover(resource.data.companyId);
      allow update: if isActiveUser() && isApprover(resource.data.companyId) && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'approvedBy', 'approvedAt', 'updatedAt']);

      // Releaser: Read + Pay
      allow read: if isActiveUser() && isReleaser(resource.data.companyId);
      allow update: if isActiveUser() && isReleaser(resource.data.companyId) && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'releasedBy', 'releasedAt', 'updatedAt']);
                       
      // User/Auditor: Access Denied (Spec: User/Auditor cannot view)
    }

    // ----------------------------------------------------------------------------------
    // Recurring Templates
    // ----------------------------------------------------------------------------------
    match /recurringTemplates/{templateId} {
      allow read, write: if isGlobalAdmin();
      
      // Manager: Full
      allow read, write: if isFinancialManager(resource.data.companyId) || isFinancialManager(request.resource.data.companyId);
      
      // Approver: Read Only
      allow read: if isApprover(resource.data.companyId);
      
      // Others: Deny
    }
    
    // ----------------------------------------------------------------------------------
    // Audit Logs
    // ----------------------------------------------------------------------------------
    match /auditLogs/{logId} {
      // Global Admin: Read
      allow read: if isGlobalAdmin();
      
      // Auditor: Read
      allow read: if isActiveUser() && isAuditor(resource.data.companyId);
      
      // User/Manager(!)/Approver/Releaser: Deny Read?
      // Spec: Manager "Não poderá visualizar".
      // Spec: Approver "Poderá visualizar".
      // Spec: Releaser "Poderá visualizar" (Same as approver).
      // Spec: Auditor "Pode visualizar".
      
      allow read: if isActiveUser() && 
                     (isApprover(resource.data.companyId) || 
                      isReleaser(resource.data.companyId) || 
                      isAuditor(resource.data.companyId));
      
      // Create: System usually creates logs via Cloud Functions (Admin SDK), bypassing rules.
      // If client creates logs:
      allow create: if isActiveUser(); // Any active user can generate an action log
      
      allow update, delete: if false; // Immutable
    }
    
    // ----------------------------------------------------------------------------------
    // Notifications
    // ----------------------------------------------------------------------------------
    match /notifications/{notificationId} {
      allow read, write: if isGlobalAdmin();
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isActiveUser();
    }
    
    // ----------------------------------------------------------------------------------
    // Budgets
    // ----------------------------------------------------------------------------------
    match /budgets/{budgetId} {
        allow read, write: if isGlobalAdmin();
        // Assume tied to cost center or company?
        // If has companyId:
        allow read, write: if isActiveUser() && isFinancialManager(resource.data.companyId);
        allow read: if isActiveUser() && (getUserData().companyRoles[resource.data.companyId] != null);
    }
  }
}