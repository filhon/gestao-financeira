rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner of the document (by ID) -- mostly for Users collection
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Fetch the current user's profile document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if the user is a Global Admin
    function isGlobalAdmin() {
      // Safely access data, if user doc doesn't exist or role is missing, this returns false/error (interpreted as deny)
      return getUserData().role == 'admin';
    }

    // Check if the user has a specific role within a company
    function hasCompanyRole(companyId, allowedRoles) {
      let user = getUserData();
      let globalRole = user.role;
      // Admin global role bypasses all checks
      let isAdmin = globalRole == 'admin';
      
      // Get role specific to the company
      // 'companyRoles' is a Map: { "companyId": "role" }
      let companyRole = user.companyRoles[companyId];
      
      // Allow if Global Admin OR if the user's company role is in the allowed list
      return isAdmin || (companyRole in allowedRoles);
    }
    
    // Helper for "Manager or Admin" check (Common pattern)
    function isManager(companyId) {
       return hasCompanyRole(companyId, ['financial_manager']);
    }

    // --- Collection Rules ---

    // 1. Users Collection
    // - Read: All authenticated users (needed for interactions, assigning users, etc.)
    // - Write: Owner can edit self; Global Admin can edit all.
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Allow creation during sign-up
      allow update: if isOwner(userId) || isGlobalAdmin();
      allow delete: if isGlobalAdmin();
    }

    // 2. Companies Collection
    // - Read: Authenticated users (Simple approach).
    // - Write: Global Admin only.
    match /companies/{companyId} {
      allow read: if isAuthenticated();
      allow write: if isGlobalAdmin();
    }

    // 3. Transactions (Payables & Receivables)
    match /transactions/{transactionId} {
      // Helper to get companyId from the document being accessed/created
      function getCompanyId() {
        return resource != null ? resource.data.companyId : request.resource.data.companyId;
      }
      
      // READ
      allow read: if isAuthenticated() && (
        // Admin, Manager, Approver, Releaser, Auditor: Can view ALL in the company
        hasCompanyRole(getCompanyId(), ['financial_manager', 'approver', 'releaser', 'auditor']) ||
        
        // User: Can view ONLY their own transactions (Created By them)
        (hasCompanyRole(getCompanyId(), ['user']) && resource.data.createdBy == request.auth.uid)
      );

      // CREATE
      allow create: if isAuthenticated() && (
         // Admin, Manager: Can create both Payables and Receivables
         hasCompanyRole(getCompanyId(), ['financial_manager']) ||
         
         // User: Can create Payables (Logic simplified: allow create if they have 'user' role)
         hasCompanyRole(getCompanyId(), ['user'])
      );

      // UPDATE / DELETE
      allow update, delete: if isAuthenticated() && (
         // Admin, Manager: Full access
         isManager(getCompanyId()) ||
         
         // Approver: Can Update (e.g. Approve)
         hasCompanyRole(getCompanyId(), ['approver']) ||
         
         // Releaser: Can Update (e.g. Pay)
         hasCompanyRole(getCompanyId(), ['releaser']) ||
         
         // User: Can Update/Delete ONLY their own transactions
         (hasCompanyRole(getCompanyId(), ['user']) && resource.data.createdBy == request.auth.uid)
      );
    }

    // 4. Payment Batches
    match /payment_batches/{batchId} {
       function getCompanyId() { return resource != null ? resource.data.companyId : request.resource.data.companyId; }
       
       allow read: if isAuthenticated() && hasCompanyRole(getCompanyId(), ['financial_manager', 'approver', 'releaser']);
       
       // Write: Managers, Approvers, Releasers (Approve/Pay actions)
       allow write: if isAuthenticated() && (
         isManager(getCompanyId()) || 
         hasCompanyRole(getCompanyId(), ['approver', 'releaser'])
       );
    }

    // 5. Recurring Templates
    match /recurring_templates/{templateId} {
       function getCompanyId() { return resource != null ? resource.data.companyId : request.resource.data.companyId; }

       // Read: Manager, Approver, Releaser
       allow read: if isAuthenticated() && hasCompanyRole(getCompanyId(), ['financial_manager', 'approver', 'releaser']);
       
       // Write: Manager only
       allow write: if isAuthenticated() && isManager(getCompanyId());
    }

    // 6. Cost Centers
    match /cost_centers/{costCenterId} {
       // All users in the company usually need to see cost centers to categorize transactions
       // Simplification: Allow all authenticated users to read.
       allow read: if isAuthenticated();
       
       // Write: Manager only
       allow write: if isAuthenticated() && isManager(resource != null ? resource.data.companyId : request.resource.data.companyId);
    }

    // 7. Entities (Participants/Contacts)
    match /entities/{entityId} {
       // Read: All authenticated users (Simplification)
       allow read: if isAuthenticated();
       
       // Write: Manager, Approver, Releaser (Maybe? Spec says View Entities for Approver/Releaser. Write is Admin/Manager.)
       // Keeping strict write:
       allow write: if isAuthenticated() && isManager(resource != null ? resource.data.companyId : request.resource.data.companyId);
    }
    
    // 8. Notifications
    match /notifications/{notificationId} {
       // Owner only
       allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid);
       // Allow write if it's for the user (system triggering not covered by rules unless using Admin SDK)
       // Or users marking as read.
       allow write: if isAuthenticated(); 
    }

    // 9. Audit Logs
    match /audit_logs/{logId} {
        // Read: Admin, Auditor, Approver, Releaser, Manager
        // User role: Cannot access audit logs
        function getCompanyId() { return resource.data.companyId; }
        
        allow read: if isAuthenticated() && (
            isGlobalAdmin() ||
            hasCompanyRole(getCompanyId(), ['auditor', 'approver', 'releaser', 'financial_manager'])
        );
        // Allow authenticated users to create audit logs (client-side logging)
        allow create: if isAuthenticated();
        // Prevent updates and deletes (audit logs should be immutable)
        allow update, delete: if false;
    }

    // 10. Budgets
    // Missing in initial pass. Linked to Cost Centers.
    // Simple approach: Allow authenticated Read/Write to avoid errors as requested.
    match /budgets/{budgetId} {
      allow read, write: if isAuthenticated();
    }

    // 11. Feedbacks
    match /feedbacks/{feedbackId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isGlobalAdmin();
    }

    // Regras do Roadmap
    match /roadmap_items/{itemId} {
      allow read: if true; // Público
      allow create: if isAuthenticated(); // Usuários logados
      allow update, delete: if isGlobalAdmin(); // Apenas admins
    }

    // 12. Cost Center Usage (Denormalized for performance)
    match /cost_center_usage/{usageId} {
       function getCompanyId() { return resource != null ? resource.data.companyId : request.resource.data.companyId; }
       
       // Read: Same as reports/dashboard
       allow read: if isAuthenticated() && hasCompanyRole(getCompanyId(), ['financial_manager', 'approver', 'releaser', 'auditor', 'user']);
       
       // Write: Anyone who can create/update transactions needs to update usage
       allow write: if isAuthenticated() && hasCompanyRole(getCompanyId(), ['financial_manager', 'approver', 'releaser', 'user']);
    }
    
    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}